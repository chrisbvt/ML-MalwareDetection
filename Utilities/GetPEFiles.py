import glob2
import shutil
import os

def check_if_pe_file(file):
    try:
        file_read = open(file, 'rb')
        header = file_read.read(2)
        file_read.close()
        if header == 'MZ':
            return 1
        return 0
    except:
        print str(file) + " could not be read"
        return 0


def main():
    files = glob2.glob('c:\\windows\\**')
    dest = "c:\\copied_files"

    os.mkdir("c:\\copied_files")

    file_dict = {}

    for file_name in files:

        if check_if_pe_file(file_name):
            name = file_name.split("\\")[-1]
            if name not in file_dict:
                try:
                    shutil.copy2(file_name, dest)
                except:
                    print ""
                file_dict[name] = 1
                print file_name
            else:
                succeeded = False
                num = 1

                while not succeeded:

                    to_name = dest + "\\" + str(file_name.split()[-1]) + str(num)
                    if os._exists(to_name):
                        num += 1
                        continue
                    try:
                        #print name_to_copy_to
                        #shutil.move(dest + file_name.split("\\")[-1], dest + file_name.split("\\"[-1] + str(num)))
                        print "Found duplicate: %s" % file_name
                        shutil.copy2(file_name, dest + "\\" + name + str(num))
                    except:
                        print "Failed to copy: " + file_name
                    succeeded = True

if __name__ == "__main__":
    main()